const w=new TextEncoder,f=new TextDecoder,h=16,E=async e=>{const t=w.encode(e.padEnd(32).slice(0,32));return crypto.subtle.importKey("raw",t,{name:"AES-CBC"},!1,["encrypt","decrypt"])},i=e=>btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),l=e=>{const t=e.replace(/-/g,"+").replace(/_/g,"/").padEnd(e.length+(4-e.length%4)%4,"="),n=atob(t);return Uint8Array.from(n,r=>r.charCodeAt(0))};async function u(e,t,n=60*60*1e3){const r=crypto.getRandomValues(new Uint8Array(h)),d=Date.now()+n,s=JSON.stringify({...e,exp:d}),p=await E(t),c=await crypto.subtle.encrypt({name:"AES-CBC",iv:r},p,w.encode(s)),a=new Uint8Array(c);return`${i(r)}.${i(a)}`}async function g(e,t){if(!e||typeof e!="string"||!e.includes("."))throw new Error("Invalid or missing token");const[n,r]=e.split(".");if(!n||!r)throw new Error("Invalid token format");const d=l(n),s=l(r),p=await E(t);let c;try{c=await crypto.subtle.decrypt({name:"AES-CBC",iv:d},p,s)}catch{throw new Error("Failed to decrypt token")}let a;try{a=f.decode(c)}catch{throw new Error("Unable to decode decrypted data")}let o;try{o=JSON.parse(a)}catch{throw new Error("Invalid token payload JSON")}if(typeof o.exp!="number"||Date.now()>o.exp)throw new Error("Token has expired");return delete o.exp,o}export{u as c,g as d};
